<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios - CardioPix</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/2.0.0/modern-normalize.min.css" integrity="sha512-3bPJw7RP4eAbOeXtfLOcAfeUOLuO/7lzmdPqmq4/hIrbtlGGvFXwkzYsuocZB4mlj2FCkdpQ76qE+0egqVJrWA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: #f5f6fb; color: #1a1a1a; }
        header { background: linear-gradient(90deg, #1a6ed8, #4b9bff); color: white; padding: 20px; }
        header h1 { margin: 0; font-size: 24px; }
        main { padding: 24px; max-width: 1200px; margin: 0 auto; }
        .filters { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); margin-bottom: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .filters label { font-size: 12px; color: #4b5563; display: block; margin-bottom: 4px; }
        .filters input, .filters select, .filters button { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 14px; }
        .filters button { background: #1a6ed8; color: white; border: none; cursor: pointer; transition: background .2s; }
        .filters button:hover { background: #155bb5; }
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 14px; margin-bottom: 16px; }
        .card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
        .card h3 { margin: 0 0 8px 0; font-size: 14px; text-transform: uppercase; color: #6b7280; letter-spacing: 0.08em; }
        .card .value { font-size: 28px; font-weight: 700; color: #111827; }
        .card small { color: #6b7280; }
        .section { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); margin-bottom: 16px; }
        table { width: 100%; border-collapse: collapse; }
        table thead { background: #f3f4f6; }
        table th, table td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; font-size: 14px; }
        table th { color: #6b7280; font-weight: 600; }
        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        .pagination button { padding: 8px 12px; border-radius: 8px; border: 1px solid #d1d5db; background: white; cursor: pointer; }
        .chart-container { position: relative; height: 260px; margin-top: 12px; }
    </style>
</head>
<body>
    <header>
        <h1>Relatórios</h1>
        <p>Faturamento por laudos concluídos, contagem de exames e ranking de médicos.</p>
    </header>
    <main>
        <section class="filters">
            <div>
                <label for="start-date">Período inicial</label>
                <input type="date" id="start-date" />
            </div>
            <div>
                <label for="end-date">Período final</label>
                <input type="date" id="end-date" />
            </div>
            <div>
                <label for="clinic">Clínica</label>
                <select id="clinic">
                    <option value="">Todas</option>
                    <option value="CLIN-01">Clínica Central</option>
                    <option value="CLIN-02">Clínica Sul</option>
                    <option value="CLIN-03">Clínica Norte</option>
                </select>
            </div>
            <div>
                <label for="doctor">Médico</label>
                <select id="doctor">
                    <option value="">Todos</option>
                    <option value="DOC-01">Dra. Silva</option>
                    <option value="DOC-02">Dr. Pereira</option>
                    <option value="DOC-03">Dr. Souza</option>
                </select>
            </div>
            <div>
                <label for="page-size">Itens por página</label>
                <select id="page-size">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15">15</option>
                </select>
            </div>
            <div style="align-self: end;">
                <button id="apply-filters">Aplicar filtros</button>
            </div>
        </section>

        <section class="cards">
            <div class="card">
                <h3>Faturamento (Laudado)</h3>
                <div class="value" id="revenue">R$ 0,00</div>
                <small>Somente laudos concluídos</small>
            </div>
            <div class="card">
                <h3>Exames Realizados</h3>
                <div class="value" id="realizados">0</div>
            </div>
            <div class="card">
                <h3>Exames Pendentes</h3>
                <div class="value" id="pendentes">0</div>
            </div>
            <div class="card">
                <h3>Exames Repetidos</h3>
                <div class="value" id="repetidos">0</div>
            </div>
        </section>

        <section class="section">
            <h2>Gráfico quantitativo</h2>
            <p>Total por status de exame.</p>
            <div class="chart-container">
                <canvas id="status-chart"></canvas>
            </div>
        </section>

        <section class="section">
            <h2>Ranking de médicos (Laudos emitidos)</h2>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Médico</th>
                            <th>Laudos emitidos</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body">
                        <tr><td colspan="2">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination">
                <div>
                    <button id="prev-page">Anterior</button>
                    <button id="next-page">Próxima</button>
                </div>
                <span id="page-info"></span>
            </div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        const revenueEl = document.getElementById('revenue');
        const realizadosEl = document.getElementById('realizados');
        const pendentesEl = document.getElementById('pendentes');
        const repetidosEl = document.getElementById('repetidos');
        const rankingBody = document.getElementById('ranking-body');
        const pageInfo = document.getElementById('page-info');
        const startDate = document.getElementById('start-date');
        const endDate = document.getElementById('end-date');
        const clinicSelect = document.getElementById('clinic');
        const doctorSelect = document.getElementById('doctor');
        const pageSizeSelect = document.getElementById('page-size');
        const applyButton = document.getElementById('apply-filters');
        const prevPageButton = document.getElementById('prev-page');
        const nextPageButton = document.getElementById('next-page');

        let chartInstance = null;
        let currentPage = 1;

        const currencyFormatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

        function buildQuery(pageOverride) {
            const params = new URLSearchParams();
            if (startDate.value) params.append('start_date', startDate.value);
            if (endDate.value) params.append('end_date', endDate.value);
            if (clinicSelect.value) params.append('clinic_id', clinicSelect.value);
            if (doctorSelect.value) params.append('doctor_id', doctorSelect.value);
            params.append('page', pageOverride || currentPage);
            params.append('page_size', pageSizeSelect.value || '5');
            return params.toString();
        }

        async function loadData(pageOverride) {
            if (pageOverride) currentPage = pageOverride;
            const query = buildQuery(pageOverride);
            const response = await fetch(`/reports/aggregate?${query}`);
            const data = await response.json();
            renderCards(data);
            renderChart(data.counts);
            renderRanking(data.ranking);
        }

        function renderCards(data) {
            revenueEl.textContent = currencyFormatter.format(data.revenue_laudos || 0);
            realizadosEl.textContent = data.counts?.Realizado || 0;
            pendentesEl.textContent = data.counts?.Pendente || 0;
            repetidosEl.textContent = data.counts?.Repetido || 0;
        }

        function renderChart(counts) {
            const labels = ['Realizados', 'Pendentes', 'Repetidos'];
            const values = [counts.Realizado || 0, counts.Pendente || 0, counts.Repetido || 0];
            const colors = ['#1a6ed8', '#f59e0b', '#ef4444'];

            const ctx = document.getElementById('status-chart').getContext('2d');
            if (chartInstance) {
                chartInstance.data.datasets[0].data = values;
                chartInstance.update();
                return;
            }
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Exames',
                        data: values,
                        backgroundColor: colors,
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
        }

        function renderRanking(ranking) {
            if (!ranking.items.length) {
                rankingBody.innerHTML = '<tr><td colspan="2">Sem resultados para os filtros selecionados.</td></tr>';
            } else {
                rankingBody.innerHTML = ranking.items.map(item => `
                    <tr>
                        <td>${item.doctor_name} (${item.doctor_id})</td>
                        <td>${item.laudos_emitidos}</td>
                    </tr>
                `).join('');
            }

            pageInfo.textContent = `Página ${ranking.page} de ${Math.max(1, Math.ceil(ranking.total / ranking.page_size))}`;
            prevPageButton.disabled = ranking.page <= 1;
            nextPageButton.disabled = ranking.page * ranking.page_size >= ranking.total;
        }

        applyButton.addEventListener('click', () => loadData(1));
        prevPageButton.addEventListener('click', () => {
            if (currentPage > 1) loadData(currentPage - 1);
        });
        nextPageButton.addEventListener('click', () => loadData(currentPage + 1));

        loadData();
    </script>
</body>
</html>
